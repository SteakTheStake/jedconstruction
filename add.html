
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Image - JED Construction & Remodeling LLC</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="./style/style.css" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">JED Construction & Remodeling</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Back to Home</a>
                <a class="nav-link" href="#" id="logoutBtn" style="display: none;" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <!-- Authentication Form -->
    <section class="py-5" id="authSection" style="margin-top: 80px;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-center mb-4">Admin Access Required</h3>
                            <p class="text-center text-muted mb-4">Please enter the access code to manage gallery images.</p>
                            
                            <form id="authForm">
                                <div class="mb-3">
                                    <label for="accessCode" class="form-label">Access Code</label>
                                    <input type="password" class="form-control" id="accessCode" required placeholder="Enter access code">
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Access Admin Panel</button>
                                </div>
                            </form>
                            
                            <div id="authMessage" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Add Image Form (Hidden by default) -->
    <section class="py-5" id="adminSection" style="margin-top: 80px; display: none;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <h2 class="text-center mb-5">Add New Project Image</h2>
                    
                    <div class="card">
                        <div class="card-body">
                            <form id="imageForm">
                                <div class="mb-3">
                                    <label for="category" class="form-label">Project Category</label>
                                    <select class="form-select" id="category" required>
                                        <option value="">Select a category</option>
                                        <option value="exterior-siding">Exterior Siding</option>
                                        <option value="roof-repairs">Roof Repairs</option>
                                        <option value="new-home">New Home Construction</option>
                                        <option value="deck-addition">Backyard Deck Addition</option>
                                        <option value="custom">+ Create New Category</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3" id="customCategoryDiv" style="display: none;">
                                    <label for="customCategory" class="form-label">New Category Name</label>
                                    <input type="text" class="form-control" id="customCategory" placeholder="Enter new category name">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="imageFile" class="form-label">Image File</label>
                                    <input type="file" class="form-control" id="imageFile" accept="image/*" required>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" rows="3" placeholder="Enter a brief description of this project image" required></textarea>
                                </div>
                                
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary">Add Image</button>
                                </div>
                            </form>
                            
                            <div id="message" class="mt-3"></div>
                        </div>
                    </div>
                    
                    <!-- Gallery Management Section -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h5 class="card-title">Manage Gallery</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="manageCategory" class="form-label">Filter by Category</label>
                                    <select class="form-select" id="manageCategory">
                                        <option value="">All Categories</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger" onclick="deleteCategory()">Delete Category</button>
                                </div>
                            </div>
                            
                            <div id="galleryImages" class="row"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Edit Image Modal -->
    <div class="modal fade" id="editImageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editImageForm">
                        <input type="hidden" id="editImageId">
                        <div class="mb-3">
                            <label for="editCategory" class="form-label">Category</label>
                            <select class="form-select" id="editCategory" required>
                                <option value="exterior-siding">Exterior Siding</option>
                                <option value="roof-repairs">Roof Repairs</option>
                                <option value="new-home">New Home Construction</option>
                                <option value="deck-addition">Backyard Deck Addition</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <img id="editImagePreview" class="img-fluid" style="max-height: 200px;">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveImageEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="cms.js"></script>
    <script>
        // Secure authentication system with hashing and salt
        // To set a new password, run: await hashPassword('YourNewPassword') in browser console
        const SALT = 'JED_CONSTRUCTION_2024_SECURE_SALT_STRING';
        
        // Generate the correct hash for the password
        let PASSWORD_HASH = '';
        
        // Initialize the correct password hash
        async function initializePasswordHash() {
            PASSWORD_HASH = await hashPassword('Adm!n!mgUpload2025');
        }
        
        // Call initialization
        initializePasswordHash();
        
        // Secure password hashing function
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + SALT);
            const hash = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hash));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            console.log('Password hash:', hashHex);
            return hashHex;
        }
        
        // Rate limiting to prevent brute force attacks
        let failedAttempts = 0;
        let lastFailedAttempt = 0;
        const MAX_ATTEMPTS = 5;
        const LOCKOUT_TIME = 15 * 60 * 1000; // 15 minutes
        
        function checkRateLimit() {
            const now = Date.now();
            if (failedAttempts >= MAX_ATTEMPTS) {
                const timeSinceLastAttempt = now - lastFailedAttempt;
                if (timeSinceLastAttempt < LOCKOUT_TIME) {
                    const remainingTime = Math.ceil((LOCKOUT_TIME - timeSinceLastAttempt) / 60000);
                    return { allowed: false, remainingMinutes: remainingTime };
                } else {
                    // Reset after lockout period
                    failedAttempts = 0;
                }
            }
            return { allowed: true };
        }
        
        function checkAuth() {
            const authToken = sessionStorage.getItem('jedAdminAuth');
            const authTime = sessionStorage.getItem('jedAdminAuthTime');
            const now = Date.now();
            const SESSION_TIMEOUT = 2 * 60 * 60 * 1000; // 2 hours
            
            // Check if session is valid and not expired
            const isAuthenticated = authToken === 'true' && 
                                  authTime && 
                                  (now - parseInt(authTime)) < SESSION_TIMEOUT;
            
            if (isAuthenticated) {
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('adminSection').style.display = 'block';
                document.getElementById('logoutBtn').style.display = 'block';
            } else {
                // Clear expired session
                sessionStorage.removeItem('jedAdminAuth');
                sessionStorage.removeItem('jedAdminAuthTime');
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('adminSection').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'none';
            }
        }
        
        function showAuthMessage(text, type) {
            const messageDiv = document.getElementById('authMessage');
            messageDiv.innerHTML = `<div class="alert alert-${type}" role="alert">${text}</div>`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
        
        function logout() {
            sessionStorage.removeItem('jedAdminAuth');
            sessionStorage.removeItem('jedAdminAuthTime');
            checkAuth();
            showAuthMessage('Logged out successfully.', 'info');
        }
        
        // Handle authentication form with enhanced security
        document.getElementById('authForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const rateLimit = checkRateLimit();
            if (!rateLimit.allowed) {
                showAuthMessage(`Too many failed attempts. Please wait ${rateLimit.remainingMinutes} minutes before trying again.`, 'danger');
                return;
            }
            
            const enteredCode = document.getElementById('accessCode').value;
            
            // Add artificial delay to slow down brute force attempts
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const enteredHash = await hashPassword(enteredCode);
            
            // Ensure PASSWORD_HASH is initialized
            if (!PASSWORD_HASH) {
                PASSWORD_HASH = await hashPassword('Adm!n!mgUpload2025');
            }
            
            if (enteredHash === PASSWORD_HASH) {
                // Reset failed attempts on success
                failedAttempts = 0;
                
                sessionStorage.setItem('jedAdminAuth', 'true');
                sessionStorage.setItem('jedAdminAuthTime', Date.now().toString());
                checkAuth();
                showAuthMessage('Access granted! Welcome to the admin panel.', 'success');
                document.getElementById('accessCode').value = '';
            } else {
                failedAttempts++;
                lastFailedAttempt = Date.now();
                
                const remainingAttempts = MAX_ATTEMPTS - failedAttempts;
                if (remainingAttempts > 0) {
                    showAuthMessage(`Invalid access code. ${remainingAttempts} attempts remaining.`, 'danger');
                } else {
                    showAuthMessage('Too many failed attempts. Access locked for 15 minutes.', 'danger');
                }
                document.getElementById('accessCode').value = '';
            }
        });
        
        // Handle custom category selection
        document.getElementById('category').addEventListener('change', function() {
            const customDiv = document.getElementById('customCategoryDiv');
            if (this.value === 'custom') {
                customDiv.style.display = 'block';
                document.getElementById('customCategory').required = true;
            } else {
                customDiv.style.display = 'none';
                document.getElementById('customCategory').required = false;
            }
        });
        
        // Populate manage category dropdown
        function populateManageCategories() {
            const cms = new GalleryCMS();
            const categories = cms.getCategories();
            const select = document.getElementById('manageCategory');
            
            // Clear existing options except "All Categories"
            select.innerHTML = '<option value="">All Categories</option>';
            
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.key;
                option.textContent = cat.name;
                select.appendChild(option);
            });
        }
        
        // Filter gallery images
        document.getElementById('manageCategory').addEventListener('change', function() {
            displayGalleryImages(this.value);
        });
        
        // Display gallery images for management
        function displayGalleryImages(categoryFilter = '') {
            const cms = new GalleryCMS();
            const images = cms.getImages();
            const container = document.getElementById('galleryImages');
            
            container.innerHTML = '';
            
            const filteredImages = categoryFilter ? 
                images.filter(img => img.category === categoryFilter) : images;
            
            filteredImages.forEach(image => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                col.innerHTML = `
                    <div class="card">
                        <img src="${image.src}" class="card-img-top" style="height: 200px; object-fit: cover;">
                        <div class="card-body">
                            <p class="card-text small">${image.description}</p>
                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-outline-primary" onclick="editImage(${image.id})">Edit</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteImage(${image.id})">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(col);
            });
        }
        
        // Edit image function
        function editImage(imageId) {
            const cms = new GalleryCMS();
            const image = cms.getImageById(imageId);
            
            if (image) {
                document.getElementById('editImageId').value = image.id;
                document.getElementById('editCategory').value = image.category;
                document.getElementById('editDescription').value = image.description;
                document.getElementById('editImagePreview').src = image.src;
                
                // Populate edit category dropdown with all categories
                const categories = cms.getCategories();
                const editSelect = document.getElementById('editCategory');
                editSelect.innerHTML = '';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.key;
                    option.textContent = cat.name;
                    if (cat.key === image.category) option.selected = true;
                    editSelect.appendChild(option);
                });
                
                const modal = new bootstrap.Modal(document.getElementById('editImageModal'));
                modal.show();
            }
        }
        
        // Save image edit
        function saveImageEdit() {
            const cms = new GalleryCMS();
            const imageId = parseInt(document.getElementById('editImageId').value);
            const category = document.getElementById('editCategory').value;
            const description = document.getElementById('editDescription').value;
            
            if (cms.updateImage(imageId, { category, description })) {
                showAuthMessage('Image updated successfully!', 'success');
                displayGalleryImages(document.getElementById('manageCategory').value);
                const modal = bootstrap.Modal.getInstance(document.getElementById('editImageModal'));
                modal.hide();
            } else {
                showAuthMessage('Failed to update image.', 'danger');
            }
        }
        
        // Delete image function
        function deleteImage(imageId) {
            if (confirm('Are you sure you want to delete this image?')) {
                const cms = new GalleryCMS();
                if (cms.deleteImage(imageId)) {
                    showAuthMessage('Image deleted successfully!', 'success');
                    displayGalleryImages(document.getElementById('manageCategory').value);
                } else {
                    showAuthMessage('Failed to delete image.', 'danger');
                }
            }
        }
        
        // Delete category function
        function deleteCategory() {
            const categoryKey = document.getElementById('manageCategory').value;
            if (!categoryKey) {
                showAuthMessage('Please select a category to delete.', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to delete this category and all its images?')) {
                const cms = new GalleryCMS();
                if (cms.deleteCategory(categoryKey)) {
                    showAuthMessage('Category deleted successfully!', 'success');
                    populateManageCategories();
                    displayGalleryImages();
                    document.getElementById('manageCategory').value = '';
                } else {
                    showAuthMessage('Failed to delete category.', 'danger');
                }
            }
        }
        
        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            if (sessionStorage.getItem('jedAdminAuth') === 'true') {
                populateManageCategories();
                displayGalleryImages();
            }
        });
    </script>
</body>
</html>
